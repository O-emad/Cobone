@page "/account/data"
@inject IAccountDataService AccountDataService
@inject IAccountAddressDataService AccountAddressDataService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
<MudGrid Spacing="8" Class="pl-8 pr-3">
    <AccountNavigationMenu Lg="2" Xl="2" Xxl="1" Md="3" Sm="4" Xs="4"></AccountNavigationMenu>
    <MudItem lg="10" xl="10" xxl="11" md="9" sm="8" xs="8" Class="pt-3">
        <MudGrid>
            <MudPaper Class="flex-grow-1 ma-0 " Width="64px" Elevation="3">

            </MudPaper>
        </MudGrid>
                <MudGrid Justify="Justify.Center" Spacing="2">
            <MudItem xs="12" xxl="12">
            <MudCard>
    <MudCardHeader Class="pa-6">
        <MudText Typo="Typo.h6">Settings</MudText>
    </MudCardHeader>
    <MudCardContent>
                        @if(AccountDetails is not null)
                        {
                            <MudStack>
                            <MudTextField @bind-Value="AccountDetails.Firstname" Label="First Name" Disabled="@DisableEdit" Variant="Variant.Outlined" />
                            <MudTextField @bind-Value="AccountDetails.Lastname" Label="Last Name" Disabled="@DisableEdit" Variant="Variant.Outlined" />
                            <MudTextField @bind-Value="AccountDetails.Email" Label="Email" Disabled="@DisableEdit" Variant="Variant.Outlined" />
                            <MudTextField @bind-Value="AccountDetails.Telephone" Label="Phone" Disabled="@DisableEdit" Variant="Variant.Outlined" />
                            </MudStack>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled" FullWidth="true" Size="Size.Large" Class="ma-2"
                        OnClick="OnSettingsButtonClick" Color="Color.Primary">@ButtonText</MudButton>
                        <MudButton Variant="Variant.Filled" FullWidth="true" Size="Size.Large" Class="ma-2"
                         OnClick="OpenChangePasswordDialog" Color="Color.Primary">Change Password</MudButton>
                    </MudCardActions>
        </MudCard>
        </MudItem>
        </MudGrid>
    </MudItem>


</MudGrid>


@code{
    public AccountDetails? AccountDetails { get; set; } = null;
    public bool DisableEdit { get; set; } = true;
    public string ButtonText { get; set; } = "Edit";
    protected override async Task OnInitializedAsync()
    {
        if(AccountDataService is not null)
        {
            AccountDetails = await AccountDataService.GetAccountDetails();
        }
    }

    private async Task OnSettingsButtonClick()
    {
        if (DisableEdit && AccountDataService is not null)
        {
            DisableEdit = false;
            ButtonText = "Save Changes";
            return;
        }
        if(!DisableEdit && AccountDataService is not null && AccountDetails is not null)
        {
            AccountUpdateDetails updateDetails = new AccountUpdateDetails
                {
                    Firstname = AccountDetails.Firstname,
                    Lastname = AccountDetails.Lastname,
                    Telephone = AccountDetails.Telephone,
                    Email = AccountDetails.Email
                };
            await AccountDataService.UpdateAccountDetails(updateDetails);
            Snackbar.Clear();
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Account Updated Successfully", Severity.Success);
            DisableEdit = true;
            ButtonText = "Edit";
            return;
        }
    }

    private async Task OpenChangePasswordDialog()
    {
        DialogOptions closeOnEscapeKey = new DialogOptions() { CloseOnEscapeKey = true, CloseButton = true, FullWidth = true };
        var dialogParameters = new DialogParameters
            {
                ["snackbarMessage"] = "Password Changed Successfully"
            };
        var dialog = DialogService.Show<ChangePasswordDialog>("Change Password", dialogParameters, closeOnEscapeKey);
        var result = await dialog.Result;
        //if (result is not null && result.Data is not null && (bool)result.Data) await table.ReloadServerData();
    }

}