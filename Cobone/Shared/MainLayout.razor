@inherits LayoutComponentBase
@inject ICategoryDataService CategoryDataService
@inject IHomeDataService HomeDataService
@inject NavigationManager NavigationManager
@inject IAccountDataService AccountDataService
@inject ICartDataService CartDataService
@inject IBreakpointService BreakpointListener

@using System.Net
<MudThemeProvider Theme="MyCustomTheme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudGrid Justify="Justify.Center" Spacing="1">


        <!---AppBar-->
        <MudItem sm="12" xs="12" Style="padding:0">
            <MudAppBar Fixed="false" Color="Color.Primary" Elevation="0" Style="padding-top:10px; padding-bottom:10px;">

                @if (breakPoint < Breakpoint.Lg)
                {
                    <MudIconButton DisableElevation="true" DisableRipple="true" Icon="@Icons.Material.Filled.Menu"
                               Color="Color.Tertiary" Size="Size.Large" OnClick="@ToggleDrawer" />
                    <MudSpacer />
                }
                <MudLink Href="/" Class="pr-5">
                    <MudImage Width="181" Height="65" Fluid="true" Src="images/logo.png"  />
                </MudLink>

                <MudTextField  @bind-Value="Search" Label="Search" Variant="Variant.Filled" Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Filled.Search" AdornmentColor="Color.Primary" Class="pa-0 ma-0" Style="@($"background:{Colors.Grey.Lighten2}")"></MudTextField>
                
                <MudSpacer />

                <MudIconButton Icon="@Icons.Filled.Storefront" DisableElevation="true" DisableRipple="true" Size="Size.Large" Color="Color.Tertiary" OnClick="NavigateToMerchant"/>
                <MudButton  DisableElevation="true" DisableRipple="true" Size="Size.Large" Color="Color.Tertiary"
                            OnClick="OpenSpecialPopOver">
                            <MudIcon Icon="@Icons.Filled.LocalOffer" Size="Size.Large" Color="Color.Tertiary"></MudIcon>

                    <MudPopover @bind-Open="SpecialPopoverOpen" OverflowBehavior="OverflowBehavior.FlipAlways" Direction="Direction.Top"
                                AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.BottomRight" RelativeWidth="false" Style="z-index:500">
                        <div class="pa-5">
                            <MudItem xs="12" xxl="12" Class="d-flex flex-grow-1 gap-4">
                                <MudText Typo="Typo.h6" Class="pr-5">Special Offers</MudText>
                                <MudSpacer />
                                <MudIconButton OnClick="CloseOverlay" Icon="@Icons.Outlined.Close" Class="pa-0 pl-5"></MudIconButton>
                            </MudItem>
                        </div>
                    </MudPopover>
                </MudButton>

                @if (breakPoint > Breakpoint.Md)
                {
                    <AuthorizeView>
                        <NotAuthorized>
                            <MudIconButton DisableElevation="true" DisableRipple="true" OnClick="GoToLogin" Icon="@Icons.Outlined.AccountCircle"
                                       Size="Size.Large" Color="Color.Tertiary">

                            </MudIconButton>
                        </NotAuthorized>

                        <Authorized>
                            <MudMenu Dense="true" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                                <ActivatorContent>
                                    <MudIconButton DisableElevation="true" DisableRipple="true" Icon="@Icons.Outlined.AccountCircle"
                                               Size="Size.Large" Color="Color.Tertiary">
                                    </MudIconButton>
                                </ActivatorContent>
                                <ChildContent>
                                    <MudMenuItem Href="account/orders">Orders</MudMenuItem>
                                    <MudMenuItem Href="account/credit">Credits</MudMenuItem>
                                    <MudMenuItem Href="account/data">Settings</MudMenuItem>
                                    <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
                                </ChildContent>
                            </MudMenu>
                        </Authorized>

                    </AuthorizeView>
                }

                <MudButton DisableElevation="false" DisableRipple="false" Class="pa-4 mt-2" OnClick="OpenCartPopOver"> 
                    <MudBadge Content="@Cart.total_product_count" Visible="@(Cart.total_product_count>0)" Overlap="true" Color="Color.Dark">
                        <MudIcon Icon="@Icons.Outlined.ShoppingCart" Size="Size.Large" Color="Color.Tertiary" />
                    </MudBadge>
                    <MudPopover @bind-Open="CartPopoverOpen" OverflowBehavior="OverflowBehavior.FlipAlways" Direction="Direction.Top" 
                                AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.BottomRight" RelativeWidth="false" Style="z-index:500">
                          <div class="pa-5">
                        @*<MudGrid Class="pa-5" Spacing="2" Justify="Justify.FlexEnd" >*@
                            <MudItem xs="12" xxl="12" Class="d-flex flex-grow-1 gap-4">
                                <MudText Typo="Typo.h6" Class="pr-5">Your Shopping Cart</MudText>
                                <MudSpacer/>
                                <MudIconButton OnClick="CloseOverlay" Icon="@Icons.Outlined.Close" Class="pa-0 pl-5"></MudIconButton>
                            </MudItem>
                                                        @if (Cart.total_product_count > 0)
                            {
                            <MudItem xs="12" xxl="12" Class="py-4">
                                @foreach(var product in Cart.products){
                                    <CartItemComponent Product="@product"/>
                                }
                            </MudItem>

                                <MudItem xs="12" xxl="12" Class="pt-3" >
                                    <MudText Typo="Typo.body2">ORDER TOTAL</MudText>
                                    <MudText Typo="Typo.h6">@Cart.total</MudText>
                                </MudItem>

                                <MudButton Variant="Variant.Filled"  Color="Color.Primary" 
                             FullWidth="true" Class="my-2" Size="Size.Large">CheckOut</MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Dark"
                             FullWidth="true" Class="my-2" Size="Size.Large" OnClick="OpenCartPopOver">Continue Shopping</MudButton>
                             }
                       @* </MudGrid>*@
                        </div>
                    </MudPopover>
                </MudButton>
            </MudAppBar>
        </MudItem>
        <!---CategoriesAppBar-->
        @if (breakPoint > Breakpoint.Md)
        {
            <MudItem sm="12" xs="12">
                <CategoryAppBar Categories="@Categories">

                </CategoryAppBar>
            </MudItem>
        }
        else
        {
            <MudDrawer Class="z-30" @bind-Open="@openDrawer" Elevation="1">
                <MudPaper Elevation="25" Style="padding-top:10px;">
                    <MudToolBar>
                        <MudIconButton Icon="@Icons.Material.Outlined.ArrowBack" Color="Color.Primary" Size="Size.Large" OnClick="ToggleDrawer" />
                        <MudSpacer />
                        <MudIconButton Icon="@Icons.Outlined.AccountCircle" Color="Color.Primary" Size="Size.Large" />
                    </MudToolBar>
                </MudPaper>

                <MudPaper Width="250px" Class="py-3" Elevation="0">
                    <MudNavMenu Color="Color.Primary" Bordered="true" Rounded="true" Dense="false">
                    <MudNavLink Class="mud-nav-group" Href="/" Match="NavLinkMatch.All">Home</MudNavLink>
                   @if (Categories is not null && Categories.Count > 0)
                    {
                        @foreach(var category in Categories)
                        {
                            if (category.Categories?.Count > 0)
                            {
                                <MudNavGroup Title="@(WebUtility.HtmlDecode(category.Name))" Expanded="false" >
                                    @foreach(var subCategory in category.Categories)
                                    {
                                        <MudNavLink Href="@($"/category/{@subCategory.Category_Id}")"  Match="NavLinkMatch.All">@(WebUtility.HtmlDecode(subCategory.Name))</MudNavLink>
                                    }
                                
                                </MudNavGroup>
                            }else{
                                <MudNavLink Href="@($"/category/{@category.Category_Id}")" Match="NavLinkMatch.All"
                                 Class="mud-nav-group">@(WebUtility.HtmlDecode(category.Name))</MudNavLink>
                            }
                        }
                     }
                    </MudNavMenu>
                </MudPaper>
            </MudDrawer>
        }
        <MudItem Style="justify-content:center;" xs="10" xxl="10" Class="pa-0 mt-5">
            @if (HomeData is not null && HomeData is not default(Home?))

            {
                <TopAddCarousel SliderData="@HomeData.Slider" />
            }
        </MudItem>

    </MudGrid>


    <MudMainContent>
        <MudOverlay @bind-Visible="OverlayOpen" DarkBackground="true" ZIndex="450" AutoClose="true" OnClick="CloseOverlay" />
        <CascadingValue Value="this">
            <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-0">
                <MudGrid Justify="Justify.Center" Spacing="2">
                    <MudItem xs="10">
                        @Body
                    </MudItem>
                </MudGrid>
            </MudContainer>
        </CascadingValue>

        <MudScrollToTop>
            <MudFab Color="Color.Primary" IconSize="Size.Large" Icon="@Icons.Filled.ArrowCircleUp" />
        </MudScrollToTop>

    </MudMainContent>


</MudLayout>


